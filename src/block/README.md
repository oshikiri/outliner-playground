# BlockComponent

基本的にLogseqの挙動をベースにする。

## 編集モード/表示モード

BlockComponent には「編集モード」と「表示モード」の二種類のモードがある

- 編集モード: そのブロックのmarkdownテキストを編集できる
- 表示モード: そのブロックのmarkdownを閲覧用にレンダリングする

### モード間遷移の条件

- 表示モードのブロックを1回クリックしたとき、編集モードに遷移する
  - あるブロックがクリックされて編集モードに入ろうとしている場合、既存の編集モードのブロックがあればそのブロックは強制的に表示モードになる
- キャレットがあたっているブロックは編集モードに遷移する
- ブロック外をクリックした場合、編集モードに入っているブロックは、変更を保存した上で表示モードになる

その他遷移時の挙動

- 2個以上のブロックが同時に編集モードに入らないこと

## Markdown記法

- `[link](url)`
  - 外部リンクのクリック（表示モード）： 新規タブでURLを開く。`rel="noreferrer"` を付与する。
- inline code
- [未実装] その他多数のMarkdown記法

## テキスト編集

- テキスト入力・削除：編集中のブロック内で通常のテキストエディタと同様に文字を入力・削除できる。
- [未実装] 「Ctrl+C/X/V」：ブロック単位またはテキスト範囲のコピー／カット／ペースト
  - [未実装] ペースト（Ctrl+V）した際は、クリップボードのテキスト/HTMLがサニタイズ＆Markdown化されて挿入される。
- [未実装] 日本語IME（かな・漢字）での文字入力を阻害しないこと
  - [未実装] IME環境下でもページ参照を挿入しやすくするため、 `Ctrl+[` で `[[]]` を挿入し、カーソルをカッコの中央に配置する。

### ブロック分割・結合

- 編集モード中に「Enter」キーを押した場合、カーソル位置でテキストを前後2つに分割する
  - 前半部分は現在いるブロックに残す
  - 後半部分が新しいブロックとして下に追加されるが、現在いるブロックに子ブロックが
    - ある場合は、子ブロックの先頭に新しいブロックを追加する
    - ない場合は、現在いるブロックの次の兄弟ブロックとして、新しいブロックを追加する
  - カーソルは新ブロックの先頭へ置く
- 編集モード中、子ブロックのないブロックにおいて行頭で「Backspace」キーを押した場合、ひとつ上のブロックの末尾にテキストが結合される
  - そのブロックの末尾にカーソル移動する
  - 結合元のブロックは削除される
  - 子ブロックを持つ場合はBackspace結合が発火せず、子の昇格や削除も行われない

### Undo/Redo/Reset

- [未実装] 編集中 or ブロック構造変更時に「Ctrl+Z（undo）/Ctrl+Y（redo）」：
  → テキスト編集はエディタ内ヒストリー、ブロック移動や階層化などはアプリ側Undoで元に戻す。
- 「Ctrl+K」: 状態を初期化する

## 階層操作（インデント・アウトデント）

- 階層操作は編集モード時のみできるものとする。表示モードの場合は動作しない
- 編集モードで「Tab」キーを押した場合（インデント）
  - 前の兄弟ブロックが存在する場合は、その兄弟ブロックの子要素となり、階層が1段深くなる。
  - 存在しない場合は何も起きない
- 編集モードで「Shift+Tab」キーを押した場合（アウトデント）
  - 1段上の階層に移動する。親の直後に配置される。
  - Shift+Tab時に後続兄弟をアウトデント対象の子として吸収し、親直後に単独配置されない
- [未実装] アウトラインツリーでドラッグ＆ドロップによる階層変更

## ブロック移動・複数選択

- 編集モードで「↑/↓」キー：
  - ブロック内に1行しかない場合、上／下のブロックを編集モードにする
  - ブロック内に2行以上ある場合、
    - 最初/最後の行にある場合、上／下のブロックを編集モードにする
    - それ以外の場合、ブロック内で上／下の行に移動する
  - [未実装] ここでの「行」は本来「画面上の折返し行」を指しているが、実装ではまだそこまで考慮できていない
- [未実装] Ctrl+↑/↓等でブロック自体の順序変更ができる
- 編集モードで「←」キーを押した場合
  - カーソルがブロック先頭にある場合: 一つ前のブロック末尾に移動する
  - それ以外の場合: 1文字前に移動する
- 編集モードで「→」キーを押した場合
  - カーソルがブロック末尾にある場合: 一つ後のブロック先頭に移動する
  - それ以外の場合: 1文字後に移動する
- [未実装] ShiftやCtrlクリックで複数ブロック選択、まとめてインデント/削除/移動することができる。
- 編集モードで「Ctrl+A/Ctrl+E」: 行頭/行末へ移動する
